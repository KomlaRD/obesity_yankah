---
title: "Prevalence and associated factors of overweight/obesity among aduts with type 2 diabetes in a tertiary health facility"
format: docx
editor: visual
toc: true
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r import-libraries}
pacman::p_load(
  tidyverse,
  gtsummary,
  skimr,
  finalfit,
  rstatix,
  GGally,
  DescTools, # C statistic
  ResourceSelection, # Hosmer-Lemeshow statistic
  generalhoslem, # Hosmer-Lemeshow
  rio, #import and export
  here,
  finalfit,
  broom,
  kableExtra,
  knitr,
  lmtest
)
```

```{r import-clean-data}
obesity <- import(here("data","obesity_clean.RData"))
```

```{r remove-columns}
# Remove columns
obesity <- obesity%>%
  dplyr::select(-c(
    region,
    district,
    town,
    smoke_cigarette,
    smoke_sticks,
    last_smoking,
    quit_smoking
  ))
```

```{r inspect-dataset}
glimpse(obesity)
missing_glimpse(obesity)
ff_glimpse(obesity)
```



```{r labelling, eval=FALSE}
obesity <- obesity%>%
        mutate(
        age_years = age_years%>%
                ff_label("Age (yrs)"),
        sex = factor(sex)%>%
                ff_label("Sex"),
        educational_status = factor(educational_status)%>%
          fct_relevel(c(
            "No formal education",
            "Primary school",
            "Middle school/JSS/JHS",
            "Secondary school/SSS/SHS",
            "Tertiary"
          ))%>%
                ff_label("Educational status"),
        marital_status = factor(marital_status)%>%
                ff_label("Marital status"),
        ethnicity = factor(ethnicity)%>%
          ff_label("Ethnicity"),
        other_ethnicity = other_ethnicity%>%
          ff_label("Other ethnicity"),
        religion = factor(religion)%>%
                ff_label("Religion"),
        occupation = factor(occupation)%>%
          ff_label("Occupation"),
        employment_status = factor(employment_status)%>%
          ff_label("Employment status"),
        residential_status = factor(residential_status)%>%
          ff_label("Residential status"),
        other_residential_status = factor(other_residential_status)%>%
          ff_label("Other residential status"),
        monthly_income = factor(monthly_income)%>%
          fct_relevel(c(
            "Below 200",
            "Between 200 and 499",
            "Between 500 and 999",
            "Between 1000 and 1499",
            "1500 and above"
          ))%>%
          ff_label("Monthly income"),
        drunk_alcohol = factor(drunk_alcohol)%>%
          ff_label("Have you ever drunk alcohol?"),
        last_alcohol = factor(last_alcohol)%>%
          ff_label("When was the last time you drank alcohol?"),
        frequent_alcohol = factor(frequent_alcohol)%>%
          ff_label("How frequent do you drink alcohol?"),
        hours_sleep = hours_sleep%>%
          ff_label("How many hours do you sleep in a day?"),
        fbs_today = fbs_today%>%
          ff_label("Fasting blood glucose for today"),
        fbs_last_visit = fbs_last_visit%>%
          ff_label("Fasting blood glucose during last visit"),
        sbp = sbp%>%
          ff_label("Systolic blood pressure (mmHg)"),
        dbp = dbp%>%
          ff_label("Diastolic blood pressure (mmHg)"),
        duration_dm = duration_dm%>%
          ff_label("How long ago were you diagnosed with DM?"),
        knowledge_dm = factor(knowledge_dm)%>%
          ff_label("How did you get to know you were diabetic?"),
        other_knowledge_dm = factor(knowledge_dm)%>%
          ff_label("Other reasons provided for knowledge of DM"),
        medication = factor(medication)%>%
          ff_label("What form of medication are you on?"),
        reaction_dm = factor(reaction_dm)%>%
          ff_label("What was your reaction when you got to know you had diabetes?"),
        retinopathy = factor(retinopathy)%>%
          ff_label("Have you been diagnosed with retinopathy?"),
        cataract = factor(cataract)%>%
          ff_label("Have you been diagnosed with cataract?"),
        hypertension = factor(hypertension)%>%
          ff_label("Have you been diagnosed with hypertension?"),
        neuropathy = factor(neuropathy)%>%
          ff_label("Have you been diagnosed with neuropathy?"),
        ckd = factor(ckd)%>%
          ff_label("Have you been diagnosed with CKD?"),
        diabetic_foot = factor(diabetic_foot)%>%
          ff_label("Have you been diagnosed with diabetic foot?"),
        sexual_weakness = factor(sexual_weakness)%>%
          ff_label("Have you been diagnosed with sexual weakness?"),
        vigorous_exercise = factor(vigorous_exercise)%>%
          ff_label("Does your work involve vigorous-intensity activity?"),
        days_vigorous_exercise = days_vigorous_exercise%>%
          ff_label("In a typical week, on how many days do you do vigorous intensity activities as part of your work?"),
        time_vigourous_exercise = time_vigourous_exercise%>%
          ff_label("How much time do you spend doing vigorous-intensity activities at work on a typical day?"),
        moderate_exercise = factor(moderate_exercise)%>%
          ff_label("Does your work involve moderate-intensity activity?"),
        days_moderate_exercise = days_moderate_exercise%>%
          ff_label("In a typical week, on how many days do you do moderate intensity activities as part of your work?"),
        time_moderate_exercise = time_moderate_exercise%>%
          ff_label("How much time do you spend doing moderate-intensity activities at work on a typical day?"),
        cycle_walk = factor(cycle_walk)%>%
          ff_label("Do you walk or use a bicycle?"),
        days_cycle_walk = days_cycle_walk%>%
          ff_label("In a typical week, on how many days do you walk or cycle?"),
        time_cycle_walk = time_cycle_walk%>%
          ff_label("How much time do you spend walking or cycling?"),
        time_minimal_activity = time_minimal_activity%>%
          ff_label("How much time do you spend doing minimal intensity activity?"),
        time_sedentary = time_sedentary%>%
          ff_label("How much time do you usually spend sitting or reclining on a typical day?"),
        exercise_program = factor(exercise_program)%>%
          ff_label("Do you start exercise programs but find yourself unable to stick with them?"),
        meals_day = factor(meals_day)%>%
          ff_label("How often do you eat meals in a day?"),
        drinks_day = factor(drinks_day)%>%
          ff_label("How often do you drink sweetened beverages?"),
        sweets = factor(sweets)%>%
          ff_label("How often do you eat sweets?"),
        sweetener = factor(sweetener)%>%
          ff_label("How often do you consume sugar and honey in tea, coffee, porridge, etc?"),
        fried_foods = factor(fried_foods)%>%
          ff_label("How often do you eat fried foods?"),
        saturated_fat = factor(saturated_fat)%>%
          ff_label("How often do you eat saturated fat?"),
        refined_food = factor(refined_food)%>%
          ff_label("How often do you eat refined food items?"),
        butter = factor(butter)%>%
          ff_label("How often do you eat butter, cream, mayonnaise, etc.?"),
        eat_outside = factor(eat_outside)%>%
          ff_label("How often do you eat out of the house?"),
        height = height%>%
                ff_label("Height (cm)"),
        weight = weight%>%
                ff_label("Weight (kg)"),
        body_fat = body_fat%>%
                ff_label("Body fat (%)"),
        muscle_mass = muscle_mass%>%
                ff_label("Muscle mass (kg)"),
        visceral_fat = visceral_fat %>%
                ff_label("Visceral fat"),
        waist_circumference = waist_circumference%>%
          ff_label("Waist circumference (cm)"),
        height_metres = height/100 %>%
                ff_label("Height (m)"), 
        bmi = (weight/height_metres^2) %>%
                ff_label("BMI (kg/m2)"),
        bmi_cat = factor(bmi_cat)%>%
       fct_relevel(c("Underweight", "Normal","Overweight","Obesity"))%>% ff_label("BMI categories"),
       fbs_average = fbs_average%>%
         ff_label("Average fasting blood glucose (mmol/l)"),
       bmi_outcome = bmi_outcome%>%
         ff_label("BMI Outcome"),
       bmi_obese = bmi_obese%>%
         ff_label("Obese/Non-obese")
        )
```

```{r dummy-variable}
obesity <- obesity%>%
  mutate(
    obese_dummy = bmi_obese%>%
      fct_recode(
        "0" = "Non-obese",
        "1" = "Obese"
      )
  )
```


## Methods

### Data inspection

```{r ggpairs, message=FALSE}
obesity%>%
  dplyr::select(age_years, sex,monthly_income, hypertension)%>%
  remove_labels() %>%
  ggpairs()
```

```{r vif}
explanatory <- c("age_years", "sex", "marital_status", "educational_status", "monthly_income", "hours_sleep", "hypertension", "religion")

dependent <- "obese_dummy"

obesity%>%
  glmmulti(dependent, explanatory) %>%
  car::vif()
```

### Data analysis

Descriptive statistics performed: median (IQR); frequency and proportion.


```{r demographics}
demographics <- obesity%>%
  dplyr::select(
    age_years,
    sex,
    marital_status,
    residential_status,
    religion,
    educational_status,
    ethnicity,
    occupation,
    monthly_income,
    hours_sleep,
    fbs_average,
    bmi_outcome,
    bmi_cat,
    bmi_obese,
    hypertension
  )
```

```{r anthropometry}
anthropometry <- obesity%>%
  dplyr::select(
    weight,
    height,
    bmi,
    bmi_cat,
    waist_circumference,
    body_fat,
    visceral_fat,
    muscle_mass,
    sex,
    bmi_outcome,
    fbs_average
  )
```



```{r scatterplot-matrix, warning=FALSE, message=FALSE, eval=FALSE}
obesity%>%
  dplyr::select(age_years, hours_sleep, height, weight,bmi)%>%
  ggcorr(label = TRUE)
```


```{r descriptive-table}
demographics%>%
  dplyr::select(-c(bmi_obese, hypertension))%>%
        tbl_summary(
          missing = "no",
          sort = list(c(marital_status, ethnicity, occupation, residential_status) ~ "frequency")
        )%>%
        modify_caption("**Table 1. Characteristics of participants**")%>%
        bold_labels()%>%add_ci()
```

```{r demographics-by_outcome}
demographics%>%
  dplyr::select(-c(bmi_cat, bmi_outcome))%>%
        tbl_summary(
          by = bmi_obese,
          missing = "no",
          sort = list(c(marital_status, ethnicity, occupation, residential_status) ~ "frequency")
        )%>%
        modify_caption("**Table 2. Characteristics of participants by outcome**")%>%
        bold_labels()%>%
  add_p()%>%
  bold_p()
```


### Univariate models 


```{r univariate-models}
# Age model
age_model <- glm(obesity$obese_dummy ~ obesity$age_years, family = binomial)

# Sex model
sex_model <- glm(obesity$obese_dummy ~ obesity$sex, family = binomial)

# Marital status
marital_model <- glm(obesity$obese_dummy ~ obesity$marital_status, family = binomial)

# Educational status
educational_model <- glm(obesity$obese_dummy ~ obesity$educational_status, family = binomial)

# Monthly income
income_model <- glm(obesity$obese_dummy ~ obesity$monthly_income, family = binomial)

# Hours sleep
sleep_model <- glm(obesity$obese_dummy ~ obesity$hours_sleep, family = binomial)

# Hypertension
htn_model <- glm(obesity$obese_dummy ~ obesity$hypertension, family = binomial)

# Religion
religion_model <- glm(obesity$obese_dummy ~ obesity$religion, family = binomial)

# Occupation
occupation_model <- glm(obesity$obese_dummy ~ obesity$occupation, family = binomial)
```

```{r age-model-coefficient}
coef(age_model)%>% exp()
confint(age_model)%>% exp()
```


```{r tidy-age-model}
age_model%>%
  tidy(conf.int = TRUE, exp = TRUE)
```

```{r model-metrics}
age_model%>%
  glance()

sex_model%>%
  glance()

educational_model%>%
  glance()

htn_model%>%
  glance()

income_model%>%
  glance()

marital_model%>%
  glance()

occupation_model%>%
  glance()

religion_model%>%
  glance()

sleep_model%>%
  glance()
```

### Age model using finalfit

```{r age-model-f}
explanatory <- "age_years"
dependent <- "obese_dummy"

obesity%>%
  finalfit(dependent, explanatory, metrics = TRUE)
```

### Multiple regression

```{r multi-regression}
explanatory <- c("age_years", "sex", "marital_status", "educational_status", "monthly_income", "hours_sleep", "hypertension", "religion")
dependent <- "obese_dummy"

multifit <- obesity%>%
  finalfit(dependent, explanatory, metrics = TRUE)
```

```{r}
multifit
```

```{r table}
multifit[[1]] %>% kable(caption = "Multivariable logistic regression: using cut to convert a continuous variable as a factor (fit 3).") %>% 
  column_spec(1, width = "3.5cm")
```


```{r remove-marital-status}
explanatory <- c("age_years", "sex", "marital_status", "educational_status", "monthly_income", "hours_sleep", "hypertension", "religion")
dependent <- "obese_dummy"
explanatory_multi <- c("age_years", "sex", "educational_status", "monthly_income", "hours_sleep", "hypertension", "religion")

multiremove <- obesity%>%
  finalfit(dependent, explanatory, explanatory_multi, keep_models = TRUE, metrics = TRUE)
```

```{r}
multiremove[[1]] %>% kable(caption = "Multivariable logistic regression: using cut to convert a continuous variable as a factor (fit 3).") %>% 
  column_spec(1, width = "3.5cm")
```

```{r}
multiremove
```

### Univariate regression tables

```{r univariate-regression}
# Age model
t1 <- age_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Sex model
t2 <- sex_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Educational model
t3 <- educational_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Hypertension model
t4 <- htn_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Income model
t5 <- income_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Marital status
t6 <- marital_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Occupation model
t7 <- occupation_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Religion model
t8 <- religion_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Sleep model
t9 <- sleep_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()
```


```{r stack-uni-tables}
uni_t <- tbl_stack(list(t1, t2, t3, t4, t5, t6, t7, t8))
```


### Multiple regression model

```{r full-model}
full_model <- glm(obesity$obese_dummy ~ obesity$age_years + obesity$sex + obesity$educational_status + obesity$marital_status+ obesity$religion + obesity$occupation + obesity$monthly_income + obesity$hypertension, family = binomial)
```


```{r multi-regression-table}
full_t <- full_model%>%
  tbl_regression(exponentiate = TRUE)%>%bold_p(t = 0.049)
```

```{r final-model-fit}
final_model <- full_model%>%step(direction = "both", trace = FALSE)
```

```{r final-model-table}
final_model_t <- final_model%>%
  tbl_regression(exponentiate = TRUE)%>%bold_p(t = 0.049)
```


```{r combine-table}
tbl_merge(list(uni_t, full_t),
          tab_spanner = c("**Univariate regression**", "**Multivariable regression**"))
```



### Additional cleaning strategies employed

One height entry was entered as 14. This was changed to 140 as 14 was less probable. Another entry of height of 95 was modified to 195.

Consider removing individual with bmi of 75.5

Select with p < 0.25

