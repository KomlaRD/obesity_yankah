---
title: "Prevalence and associated factors of overweight/obesity among aduts with type 2 diabetes in a tertiary health facility"
format: html
editor: visual
toc: true
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r import-libraries}
pacman::p_load(
  tidyverse,
  gtsummary,
  skimr,
  finalfit,
  rstatix,
  GGally,
  DescTools, # C statistic
  ResourceSelection, # Hosmer-Lemeshow statistic
  generalhoslem, # Hosmer-Lemeshow
  rio, #import and export
  here
)
```

```{r import-clean-data}
obesity <- import(here("data","obesity_clean.csv"))
```

```{r remove-columns}
# Remove columns
obesity <- obesity%>%
  dplyr::select(-c(
    region,
    district,
    town,
    smoke_cigarette,
    smoke_sticks,
    last_smoking,
    quit_smoking
  ))
```

```{r labelling}
obesity <- obesity%>%
        mutate(
        age_years = age_years%>%
                ff_label("Age (yrs)"),
        sex = factor(sex)%>%
                ff_label("Sex"),
        educational_status = factor(educational_status)%>%
          fct_relevel(c(
            "No formal education",
            "Primary school",
            "Middle school/JSS/JHS",
            "Secondary school/SSS/SHS",
            "Tertiary"
          ))%>%
                ff_label("Educational status"),
        marital_satus = factor(marital_satus)%>%
                ff_label("Marital status"),
        ethnicity = factor(ethnicity)%>%
          ff_label("Ethnicity"),
        other_ethnicity = other_ethnicity%>%
          ff_label("Other ethnicity"),
        religion = factor(religion)%>%
                ff_label("Religion"),
        occupation = factor(occupation)%>%
          ff_label("Occupation"),
        employment_status = factor(employment_status)%>%
          ff_label("Employment status"),
        residential_status = factor(residential_status)%>%
          ff_label("Residential status"),
        other_residential_status = factor(other_residential_status)%>%
          ff_label("Other residential status"),
        monthly_income = factor(monthly_income)%>%
          fct_relevel(c(
            "Below 200",
            "Between 200 and 499",
            "Between 500 and 999",
            "Between 1000 and 1499",
            "1500 and above"
          ))%>%
          ff_label("Monthly income"),
        drunk_alcohol = factor(drunk_alcohol)%>%
          ff_label("Have you ever drunk alcohol?"),
        last_alcohol = factor(last_alcohol)%>%
          ff_label("When was the last time you drank alcohol?"),
        frequent_alcohol = factor(frequent_alcohol)%>%
          ff_label("How frequent do you drink alcohol?"),
        hours_sleep = hours_sleep%>%
          ff_label("How many hours do you sleep in a day?"),
        fbs_today = fbs_today%>%
          ff_label("Fasting blood glucose for today"),
        fbs_last_visit = fbs_last_visit%>%
          ff_label("Fasting blood glucose during last visit"),
        sbp = sbp%>%
          ff_label("Systolic blood pressure (mmHg)"),
        dbp = dbp%>%
          ff_label("Diastolic blood pressure (mmHg)"),
        duration_dm = duration_dm%>%
          ff_label("How long ago were you diagnosed with DM?"),
        knowledge_dm = factor(knowledge_dm)%>%
          ff_label("How did you get to know you were diabetic?"),
        other_knowledge_dm = factor(knowledge_dm)%>%
          ff_label("Other reasons provided for knowledge of DM"),
        medication = factor(medication)%>%
          ff_label("What form of medication are you on?"),
        reaction_dm = factor(reaction_dm)%>%
          ff_label("What was your reaction when you got to know you had diabetes?"),
        retinopathy = factor(retinopathy)%>%
          ff_label("Have you been diagnosed with retinopathy?"),
        cataract = factor(cataract)%>%
          ff_label("Have you been diagnosed with cataract?"),
        hypertension = factor(hypertension)%>%
          ff_label("Have you been diagnosed with hypertension?"),
        neuropathy = factor(neuropathy)%>%
          ff_label("Have you been diagnosed with neuropathy?"),
        ckd = factor(ckd)%>%
          ff_label("Have you been diagnosed with CKD?"),
        diabetic_foot = factor(diabetic_foot)%>%
          ff_label("Have you been diagnosed with diabetic foot?"),
        sexual_weakness = factor(sexual_weakness)%>%
          ff_label("Have you been diagnosed with sexual weakness?"),
        vigorous_exercise = factor(vigorous_exercise)%>%
          ff_label("Does your work involve vigorous-intensity activity?"),
        days_vigorous_exercise = days_vigorous_exercise%>%
          ff_label("In a typical week, on how many days do you do vigorous intensity activities as part of your work?"),
        time_vigourous_exercise = time_vigourous_exercise%>%
          ff_label("How much time do you spend doing vigorous-intensity activities at work on a typical day?"),
        moderate_exercise = factor(moderate_exercise)%>%
          ff_label("Does your work involve moderate-intensity activity?"),
        days_moderate_exercise = days_moderate_exercise%>%
          ff_label("In a typical week, on how many days do you do moderate intensity activities as part of your work?"),
        time_moderate_exercise = time_moderate_exercise%>%
          ff_label("How much time do you spend doing moderate-intensity activities at work on a typical day?"),
        cycle_walk = factor(cycle_walk)%>%
          ff_label("Do you walk or use a bicycle?"),
        days_cycle_walk = days_cycle_walk%>%
          ff_label("In a typical week, on how many days do you walk or cycle?"),
        time_cycle_walk = time_cycle_walk%>%
          ff_label("How much time do you spend walking or cycling?"),
        time_minimal_activity = time_minimal_activity%>%
          ff_label("How much time do you spend doing minimal intensity activity?"),
        time_sedentary = time_sedentary%>%
          ff_label("How much time do you usually spend sitting or reclining on a typical day?"),
        exercise_program = factor(exercise_program)%>%
          ff_label("Do you start exercise programs but find yourself unable to stick with them?"),
        meals_day = factor(meals_day)%>%
          ff_label("How often do you eat meals in a day?"),
        drinks_day = factor(drinks_day)%>%
          ff_label("How often do you drink sweetened beverages?"),
        sweets = factor(sweets)%>%
          ff_label("How often do you eat sweets?"),
        sweetener = factor(sweetener)%>%
          ff_label("How often do you consume sugar and honey in tea, coffee, porridge, etc?"),
        fried_foods = factor(fried_foods)%>%
          ff_label("How often do you eat fried foods?"),
        saturated_fat = factor(saturated_fat)%>%
          ff_label("How often do you eat saturated fat?"),
        refined_food = factor(refined_food)%>%
          ff_label("How often do you eat refined food items?"),
        butter = factor(butter)%>%
          ff_label("How often do you eat butter, cream, mayonnaise, etc.?"),
        eat_outside = factor(eat_outside)%>%
          ff_label("How often do you eat out of the house?"),
        height = height%>%
                ff_label("Height (cm)"),
        weight = weight%>%
                ff_label("Weight (kg)"),
        body_fat = body_fat%>%
                ff_label("Body fat (%)"),
        muscle_mass = muscle_mass%>%
                ff_label("Muscle mass (kg)"),
        visceral_fat = visceral_fat %>%
                ff_label("Visceral fat"),
        waist_circumference = waist_circumference%>%
          ff_label("Waist circumference (cm)"),
        height_metres = height/100 %>%
                ff_label("Height (m)"), 
        bmi = (weight/height_metres^2) %>%
                ff_label("BMI (kg/m2)"),
        bmi_cat = factor(bmi_cat)%>%
       fct_relevel(c("Underweight", "Normal","Overweight","Obesity"))%>% ff_label("BMI categories"),
       fbs_average = fbs_average%>%
         ff_label("Average fasting blood glucose (mmol/l)")
        )
```


## Methods

### Data analysis

Descriptive statistics performed: median (IQR); frequency and proportion.


```{r demographics}
demographics <- obesity%>%
  dplyr::select(
    age_years,
    sex,
    marital_satus,
    residential_status,
    religion,
    educational_status,
    ethnicity,
    occupation,
    monthly_income,
    hours_sleep,
    bmi_outcome,
    bmi_cat,
    bmi_obese
  )
```

```{r anthropometry}
anthropometry <- obesity%>%
  dplyr::select(
    weight,
    height,
    bmi,
    bmi_cat,
    waist_circumference,
    body_fat,
    visceral_fat,
    muscle_mass,
    sex,
    bmi_outcome,
    fbs_average
  )
```



```{r scatterplot-matrix, warning=FALSE, message=FALSE}
obesity%>%
  dplyr::select(age_years, hours_sleep, fbs_today, fbs_last_visit, sbp, dbp, height, weight, body_fat, muscle_mass, visceral_fat, waist_circumference, bmi)%>%
  ggcorr(label = TRUE)
  
  
#ggpairs(columnLabels = c("age", "hr", "fbs0", "fbs1", "sbp", "dbp", "ht", "wt", "bf", "mm", "vf", "wc", "bmi"))
```


```{r descriptive-table}
demographics%>%
  dplyr::select(-c(bmi_outcome, bmi_obese))%>%
        tbl_summary(
          missing = "no",
          sort = list(c(marital_satus, ethnicity, occupation, residential_status) ~ "frequency")
        )%>%
        modify_caption("**Table 1. Characteristics of participants**")%>%
        bold_labels()
```

```{r demographics-by_outcome}
demographics%>%
        tbl_summary(
          by = bmi_obese,
          missing = "no",
          sort = list(c(marital_satus, ethnicity, occupation, residential_status) ~ "frequency")
        )%>%
        modify_caption("**Table 2. Characteristics of participants by outcome**")%>%
        bold_labels()%>%
  add_p()%>%
  bold_p(t = 0.25)%>%add_ci()
```




```{r univariate-regression}
# demographics%>%
#   tbl_regression()
```

```{r multiple-logistic-regression, eval=FALSE}
full_model <- glm(obesity$bmi_outcome ~ obesity$age_years + obesity$sex + obesity$ethnicity + obesity$occupation + obesity$weight + obesity$height + obesity$waist_circumference + obesity$body_fat + obesity$visceral_fat + obesity$muscle_mass + obesity$sbp + obesity$dbp + obesity$knowledge_dm + obesity$retinopathy + obesity$neuropathy + obesity$eat_outside + obesity$refined_food + obesity$sweets + obesity$butter + obesity$vigorous_exercise + obesity$time_sedentary, family=binomial (link=logit)) 

# Summary
summary(full_model)

# C statistics

DescTools::Cstat(full_model)

# Hosmer lemeshow

HL <- ResourceSelection::hoslem.test(x = full_model$y, y = fitted(full_model), g = 10)
HL

# plot the observed vs expected number of cases for each of the 10 groups 
plot(HL$observed[,"y1"], HL$expected[,"yhat1"])

# Alternative hosmer
generalhoslem::logitgof(obs = full_model$y, exp = fitted(full_model), g = 10) 

# Deviance 

anova(full_model, test="Chisq")
```

```{r regression-table, eval=FALSE}
tbl_regression(full_model, exponentiate = TRUE)%>%
  add_global_p()%>%bold_p()%>%
  italicize_levels()
```

### Additional cleaning strategies employed

One height entry was entered as 14. This was changed to 140 as 14 was less probable. Another entry of height of 95 was modified to 195.

Consider removing individual with bmi of 75.5

Select with p < 0.25

