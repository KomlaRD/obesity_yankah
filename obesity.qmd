---
title: "Prevalence and associated factors of overweight/obesity among aduts with type 2 diabetes in a tertiary health facility"
format: docx
table-of-contents: true
editor: visual
fontsize: 12pt
output-file: docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r import-libraries}
pacman::p_load(
  tidyverse, # Data wrangling and analysis
  gtsummary, # Table summaries
  skimr, # Skim data
  finalfit, # Label data
  rstatix, # Statistical test
  GGally, # Correlation/Scatterplot matrix
  DescTools, # C statistic
  ResourceSelection, # Hosmer-Lemeshow statistic
  generalhoslem, # Hosmer-Lemeshow
  rio, #import and export
  here, # Final management
  broom, # Tidy output
  kableExtra, # Table
  knitr, # Knit document
  lmtest, # Testing regression models
  DataExplorer # EDA report
)
```

```{r import-clean-data}
obesity <- import(here("data","obesity_clean.RData"))
```

```{r remove-columns}
# Remove columns
obesity <- obesity%>%
  dplyr::select(-c(
    region,
    district,
    town,
    smoke_cigarette,
    smoke_sticks,
    last_smoking,
    quit_smoking
  ))
```

```{r inspect-dataset}
glimpse(obesity)
missing_glimpse(obesity)
ff_glimpse(obesity)
```

```{r dummy-variable}
obesity <- obesity%>%
  mutate(
    obese_dummy = bmi_obese%>%
      fct_recode(
        "0" = "Non-obese",
        "1" = "Obese"
      )
  )
```

## Methods

### Data inspection

```{r ggpairs, message=FALSE}
obesity%>%
  dplyr::select(age_years, sex,monthly_income, hypertension)%>%
  remove_labels() %>%
  ggpairs()
```

```{r normality-test}
# Function to perform Shapiro-Wilk test and extract p-value
shapiro_test <- function(x) {
  shapiro_result <- shapiro.test(x)
  return(shapiro_result$p.value)
}

# Extract numeric variables from the dataset
numeric_vars <- obesity %>%
  select_if(is.numeric)

# Apply the Shapiro-Wilk test to each numeric variable and tidy the results
shapiro_p_values <- numeric_vars %>%
  summarise(across(everything(), ~ shapiro_test(.))) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "P_Value")

# Display the p-values
print(shapiro_p_values)
```

```{r skim-data}
skim(obesity)
```

```{r correlation-matrix}
# Correlation matrix of numeric variables
matrix <- numeric_vars |>
  cor_mat(age_years, # Age in years
          hours_sleep, # Hours of sleep
          sbp, # Systolic blood pressure
          dbp, # Diastolic blood pressure
          duration_dm, # Duration of diabetes
          height, # Height
          weight, # Weight
          body_fat, # Body fat
          muscle_mass, # Muscle mass
          visceral_fat, # Visceral fat
          waist_circumference, # Waist circumference
          bmi, # Body mass index
          fbs_average) # Blood sugar reading
matrix
```
```{r correlation-plot}
cor_plot(matrix)
```

```{r}
ggplot(data = obesity, aes(x=sex, y=bmi)) +  
    geom_boxplot() + 
    labs( x="Sex", y="BMI")
```


```{r vif}
explanatory <- c("age_years", 
                 "sex", 
                 "marital_status", 
                 "educational_status", 
                 "monthly_income", 
                 "hours_sleep", 
                 "hypertension", 
                 "religion",
                 "drunk_alcohol" ,
                 "duration_dm",
              
                 "monthly_income",
                 "medication" ,
                  "reaction_dm",
                  "retinopathy", 
                 "cataract",
                 "neuropathy",
                  "ckd",
                 "diabetic_foot" ,
                 "height" ,
                 "weight"  ,
                 "muscle_mass",
                 "visceral_fat",
                 "waist_circumference",
                 "fbs_average"
                 )

dependent <- "obese_dummy"

obesity%>%
  glmmulti(dependent, explanatory) %>%
  car::vif()
```

### Data analysis

Descriptive statistics performed: median (IQR); frequency and proportion.

```{r demographics}
demographics <- obesity%>%
  dplyr::select(
    age_years,
    sex,
    marital_status,
    residential_status,
    religion,
    educational_status,
    ethnicity,
    occupation,
    monthly_income,
    hours_sleep,
    fbs_average,
    bmi_outcome,
    bmi_cat,
    bmi_obese,
    hypertension
  )
```

```{r anthropometry}
anthropometry <- obesity%>%
  dplyr::select(
    weight,
    height,
    bmi,
    bmi_cat,
    waist_circumference,
    body_fat,
    visceral_fat,
    muscle_mass,
    sex,
    bmi_outcome,
    fbs_average
  )
```

```{r scatterplot-matrix, warning=FALSE, message=FALSE, eval=FALSE}
obesity%>%
  dplyr::select(age_years, hours_sleep, height, weight,bmi)%>%
  ggcorr(label = TRUE)
```

```{r descriptive-table}
demographics%>%
  dplyr::select(-c(bmi_obese, hypertension))%>%
        tbl_summary(
          missing = "no",
          sort = list(c(marital_status, ethnicity, occupation, residential_status) ~ "frequency")
        )%>%
        modify_caption("**Table 1. Characteristics of participants**")%>%
        bold_labels()%>%add_ci()
```

```{r demographics-by_outcome}
demographics%>%
  dplyr::select(-c(bmi_cat, bmi_outcome))%>%
        tbl_summary(
          by = bmi_obese,
          missing = "no",
          sort = list(c(marital_status, ethnicity, occupation, residential_status) ~ "frequency")
        )%>%
        modify_caption("**Table 2. Characteristics of participants by outcome**")%>%
        bold_labels()%>%
  add_p()%>%
  bold_p()
```

### Univariate models

```{r univariate-models}
# Age model
age_model <- glm(obesity$obese_dummy ~ obesity$age_years, family = binomial)

# Sex model
sex_model <- glm(obesity$obese_dummy ~ obesity$sex, family = binomial)

# Marital status
marital_model <- glm(obesity$obese_dummy ~ obesity$marital_status, family = binomial)

# Educational status
educational_model <- glm(obesity$obese_dummy ~ obesity$educational_status, family = binomial)

# Monthly income
income_model <- glm(obesity$obese_dummy ~ obesity$monthly_income, family = binomial)

# Hours sleep
sleep_model <- glm(obesity$obese_dummy ~ obesity$hours_sleep, family = binomial)

# Hypertension
htn_model <- glm(obesity$obese_dummy ~ obesity$hypertension, family = binomial)

# Religion
religion_model <- glm(obesity$obese_dummy ~ obesity$religion, family = binomial)

# Occupation
occupation_model <- glm(obesity$obese_dummy ~ obesity$occupation, family = binomial)
```

```{r age-model-coefficient}
coef(age_model)%>% exp()
confint(age_model)%>% exp()
```

```{r tidy-age-model}
age_model%>%
  tidy(conf.int = TRUE, exp = TRUE)
```

```{r model-metrics}
age_model%>%
  glance()

sex_model%>%
  glance()

educational_model%>%
  glance()

htn_model%>%
  glance()

income_model%>%
  glance()

marital_model%>%
  glance()

occupation_model%>%
  glance()

religion_model%>%
  glance()

sleep_model%>%
  glance()
```

### Age model using finalfit

```{r age-model-f}
explanatory <- "age_years"
dependent <- "obese_dummy"

obesity%>%
  finalfit(dependent, explanatory, metrics = TRUE)
```

### Multiple regression

```{r multi-regression}
explanatory <- c("age_years", "sex", "marital_status", "educational_status", "monthly_income", "hours_sleep", "hypertension", "religion")
dependent <- "obese_dummy"

multifit <- obesity%>%
  finalfit(dependent, explanatory, metrics = TRUE)
```

```{r}
multifit
```

```{r table}
multifit[[1]] %>% kable(caption = "Multivariable logistic regression: using cut to convert a continuous variable as a factor (fit 3).") %>% 
  column_spec(1, width = "3.5cm")
```

```{r remove-marital-status}
explanatory <- c("age_years", "sex", "marital_status", "educational_status", "monthly_income", "hours_sleep", "hypertension", "religion")
dependent <- "obese_dummy"
explanatory_multi <- c("age_years", "sex", "educational_status", "monthly_income", "hours_sleep", "hypertension", "religion")

multiremove <- obesity%>%
  finalfit(dependent, explanatory, explanatory_multi, keep_models = TRUE, metrics = TRUE)
```

```{r}
multiremove[[1]] %>% kable(caption = "Multivariable logistic regression: using cut to convert a continuous variable as a factor (fit 3).") %>% 
  column_spec(1, width = "3.5cm")
```

```{r}
multiremove
```

### Univariate regression tables

```{r univariate-regression}
# Age model
t1 <- age_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Sex model
t2 <- sex_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Educational model
t3 <- educational_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Hypertension model
t4 <- htn_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Income model
t5 <- income_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Marital status
t6 <- marital_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Occupation model
t7 <- occupation_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Religion model
t8 <- religion_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()

# Sleep model
t9 <- sleep_model%>%
  tbl_regression(exponentiate = TRUE)%>%
  bold_p(t = 0.049)%>%
  bold_labels()
```

```{r stack-uni-tables}
uni_t <- tbl_stack(list(t1, t2, t3, t4, t5, t6, t7, t8))
uni_t
```

### Multiple regression model

```{r full-model}
full_model <- glm(obesity$obese_dummy ~ obesity$age_years + obesity$sex + obesity$educational_status + obesity$marital_status+ obesity$religion + obesity$occupation + obesity$monthly_income + obesity$hypertension, family = binomial)
```

```{r multi-regression-table}
full_t <- full_model%>%
  tbl_regression(exponentiate = TRUE)%>%bold_p(t = 0.049)
```

```{r final-model-fit}
final_model <- full_model%>%step(direction = "both", trace = FALSE)
```

```{r final-model-table}
final_model_t <- final_model%>%
  tbl_regression(exponentiate = TRUE)%>%bold_p(t = 0.049)
```

```{r combine-table}
tbl_merge(list(uni_t, full_t),
          tab_spanner = c("**Univariate regression**", "**Multivariable regression**"))
```

### Additional cleaning strategies employed

One height entry was entered as 14. This was changed to 140 as 14 was less probable. Another entry of height of 95 was modified to 195.

Consider removing individual with bmi of 75.5

Select with p \< 0.25
